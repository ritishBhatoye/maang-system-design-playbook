# Real Postmortem Analysis

> **真实故障案例的学习与分析。**

---

## 案例 1: 数据库连接池耗尽

### 事件概述

```
时间: 2024-01-15 14:30 UTC
影响: 支付服务完全不可用 45 分钟
影响用户: ~12,000 笔交易失败
收入损失: 约 $15,000
```

### 时间线

| 时间 | 事件 |
|------|------|
| 14:30 | 部署新版本支付服务 |
| 14:32 | 告警：支付服务错误率上升 |
| 14:35 | 值班 SRE 响应 |
| 14:40 | 发现数据库连接池满 |
| 14:45 | 尝试重启 pod |
| 14:50 | 回滚到上一版本 |
| 15:15 | 服务完全恢复 |

### 根因分析

```
问题：新版本增加了并发请求数，但数据库连接池大小未调整
     旧版本：50 并发
     新版本：200 并发
     连接池：100（不够！）
```

### 改进措施

```yaml
action_items:
  - id: 1
    title: "增加连接池监控"
    owner: "bob"
    due: "2024-01-22"
    status: "done"
    
  - id: 2
    title: "部署前检查连接池配置"
    owner: "alice"
    due: "2024-01-25"
    status: "done"
    
  - id: 3
    title: "添加连接池自动调整"
    owner: "charlie"
    due: "2024-02-15"
    status: "in_progress"
```

### 教训

1. **发布流程缺陷**：没有检查配置变更
2. **监控不足**：连接池使用率没有告警
3. **回滚太慢**：45 分钟才完全恢复

---

## 案例 2: CDN 缓存穿透

### 事件概述

```
时间: 2024-01-20 09:00 UTC
影响: 首页加载时间从 200ms 上升到 5s
影响用户: 全部用户
持续时间: 2 小时
```

### 时间线

| 时间 | 事件 |
|------|------|
| 09:00 | 新功能上线：动态 Banner |
| 09:05 | 用户投诉页面慢 |
| 09:15 | 发现源站请求暴增 100x |
| 09:30 | 识别为缓存穿透问题 |
| 10:00 | 修复 CDN 配置 |
| 11:00 | 缓存预热完成 |

### 根因分析

```
1. 新 Banner 使用用户 ID 作为 URL 的一部分
2. 每个用户访问都是不同的 URL
3. CDN 缓存命中率接近 0%
4. 全部回源请求压垮源站
```

### 改进措施

```yaml
# 静态资源分离
- banner: /static/banner-{random}.jpg  # 可缓存
- user-data: /api/user/{id}             # 不可缓存

# CDN 配置
cache_rules:
  - path: /static/*
    ttl: 86400
  - path: /api/*
    ttl: 0
```

---

## 案例 3: 第三方服务故障

### 事件概述

```
时间: 2024-01-25 16:00 UTC
影响: 登录功能不可用
原因: 第三方 OAuth 服务商故障
持续时间: 3 小时
```

### 时间线

| 时间 | 事件 |
|------|------|
| 16:00 | OAuth 服务商报告故障 |
| 16:02 | 用户无法登录 |
| 16:05 | 告警触发 |
| 16:10 | 决定：启用备用登录 |
| 16:30 | 部署备用登录方案 |
| 19:00 | OAuth 恢复 |

### 根因分析

```
1. 完全依赖单一 OAuth 提供商
2. 没有备用方案
3. OAuth 故障 = 无法登录
```

### 改进措施

```yaml
# 多 OAuth 提供商
providers:
  - name: "Google"
    primary: true
  - name: "GitHub" 
    fallback: true
    
# 备用登录
- 邮箱密码登录
- 紧急：临时免密登录
```

---

## 案例模板

```markdown
# Incident Post-Mortem: #[ID]

## Summary
[一行描述：发生了什么]

## Impact
- 影响范围：
- 用户影响：
- 持续时间：
- 业务损失：

## Timeline (UTC)
- [时间] - [事件]
- [时间] - [事件]

## Root Cause
[详细分析根本原因]

## Contributing Factors
1. [因素 1]
2. [因素 2]

## Action Items
- [ ] [具体行动项] (Owner: xxx, Due: xxx)

## Lessons Learned
1. [学到的教训]
2. [改进方向]
```

---

## 编写 Post-Mortem 原则

```
✅ 应该:
- 关注"什么"和"如何"
- 诚实面对问题
- 具体的行动项
- 分享给团队学习

❌ 不应该:
- 指责个人
- 隐瞒问题
- 模糊的行动项
- 惩罚失败
```
